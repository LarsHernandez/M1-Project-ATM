library(tidyverse)
library(lubridate)
set.seed(19092019)
# Data --------------------------------------------------------------------
temp <- tempfile()
download.file("https://sparnordopenbanking.com/downloads/open_dataset.zip", temp)
data1 <- read_csv(unz(temp, "atm_data_part1.csv"))
data2 <- read_csv(unz(temp, "atm_data_part2.csv"),
col_types = cols(rain_3h = col_double()))
unlink(temp)
# Binding the data --------------------------------------------------------
data <- bind_rows(data1, data2)
data$date <- ymd(paste0(data$year, "-", data$month, "-", data$day))
sATM <- sample_n(data, 100000, replace=F)
sATM$euro <- ifelse(sATM$currency == "EUR", TRUE, FALSE)
sATM$euro <- as.factor(sATM$euro)
ml <- sATM %>%
select(euro, month, day, weekday, hour, atm_location, card_type, weather_main) %>%
mutate(card_type = as.factor(card_type),
atm_location = as.factor(atm_location))
index    <- createDataPartition(ml$euro, p = 0.75, list = FALSE)
library(tidyverse)
library(ggforce)
library(caret)
library(yardstick)
library(knitr)
library(ggthemes)
library(ggridges)
library(kableExtra)
index    <- createDataPartition(ml$euro, p = 0.75, list = FALSE)
training <- ml[index,]
test     <- ml[-index,]
paste0("The training set has ", dim(training)[1],
" And the test set has ", dim(test)[1], " observations")
cv <- trainControl(method = "cv", number = 5)
fit_log <- train(euro ~ .,
data      = training,
trControl = cv,
tuneGrid  = expand.grid(alpha  = 0.5,
lambda = 0),
method    = "glmnet",
family    = "binomial",
metric    = 'Accuracy')
#pred_raf <- predict(fit_raf,  test)
#conf_raf <- table(pred_raf, test$euro)
#conf_raf
pred_log <- predict(fit_log,  test)
conf_log <- table(pred_log, test$euro)
conf_log
random <- rbinom(n    = length(test$euro), size = 1,
prob = mean(as.logical(training$euro)))
conf_ran <- table(as.factor(if_else(random==1, "TRUE", "FALSE")), test$euro)
conf_ran
raf <- rbind(spec(conf_raf), precision(conf_raf), accuracy(conf_raf))
#raf <- rbind(spec(conf_raf), precision(conf_raf), accuracy(conf_raf))
log <- rbind(spec(conf_log), precision(conf_log), accuracy(conf_log))
ran <- rbind(spec(conf_ran), precision(conf_ran), accuracy(conf_ran))
#raf$model <- "Random Forrest"
log$model <- "Logistic Regression"
ran$model <- "Random Assignment"
df <- rbind(raf, log, ran)
#raf <- rbind(spec(conf_raf), precision(conf_raf), accuracy(conf_raf))
log <- rbind(spec(conf_log), precision(conf_log), accuracy(conf_log))
ran <- rbind(spec(conf_ran), precision(conf_ran), accuracy(conf_ran))
#raf$model <- "Random Forrest"
log$model <- "Logistic Regression"
ran$model <- "Random Assignment"
df <- rbind(log, ran)
ggplot(df, aes(.metric, .estimate, fill = reorder(model, desc(.estimate)))) +
geom_col(position="dodge", width = 0.6) +
scale_fill_tableau(palette = "Miller Stone", type = "regular") +
labs(title="Model performance on predicting Legendary status",
subtitle="Crossvalidated 1/5 split", fill="Predictive Model")
#raf <- rbind(spec(conf_raf), precision(conf_raf), accuracy(conf_raf))
log <- rbind(spec(conf_log), precision(conf_log), accuracy(conf_log), recall(conf_log), npv(conf_log))
#raf <- rbind(spec(conf_raf), precision(conf_raf), accuracy(conf_raf))
log <- rbind(spec(conf_log), precision(conf_log), accuracy(conf_log), recall(conf_log), npv(conf_log))
ran <- rbind(spec(conf_ran), precision(conf_ran), accuracy(conf_ran), recall(conf_ran), npv(conf_ran))
#raf$model <- "Random Forrest"
log$model <- "Logistic Regression"
ran$model <- "Random Assignment"
df <- rbind(log, ran)
ggplot(df, aes(.metric, .estimate, fill = reorder(model, desc(.estimate)))) +
geom_col(position="dodge", width = 0.6) +
scale_fill_tableau(palette = "Miller Stone", type = "regular") +
labs(title="Model performance on predicting Legendary status",
subtitle="Crossvalidated 1/5 split", fill="Predictive Model")
install.packages("geosphere")
load(file="generated_data/bATM.Rdata")
sATM <- bATM
# Holidays ----------------------------------------------------------------
# Denmark
# Ferie i Nordjylland (http://skoleferie-dk.dk/skoleferie-nordjylland/)
Jul    <- ifelse(((sATM$month=="December" & 20<=sATM$day) | (sATM$month=="January" & sATM$day<=4)), TRUE,FALSE)
Vinter <- ifelse((sATM$month=="February" & 11<=sATM$day & sATM$day<=26), TRUE,FALSE)
Paaske <- ifelse((sATM$month=="April" & 8 <= sATM$day & sATM$day<=17), TRUE,FALSE)
Sommer <- ifelse(((sATM$month=="June" & 23<=sATM$day) | (sATM$month=="July" & sATM$day>=1)| (sATM$month=="August" & sATM$day<=13)), TRUE,FALSE)
Efter  <- ifelse((sATM$month=="October" & 14<=sATM$day & sATM$day<=22), TRUE,FALSE)
sATM$holliday <- Jul | Vinter | Paaske | Sommer | Efter
# Distance to other ATMs --------------------------------------------------
mat <- as.matrix(data.frame(lon = sATM$atm_lon,
lat = sATM$atm_lat))
Aal.luft <- c(9.842829962 , 57.088999644)
Bil.luft <- c(9.150999396 , 55.73749705)
Køb.luft <- c(12.650462   , 55.620750)
#Afstand er i meter og i luftlinje:
sATM$Aal.luft <- distHaversine(mat, Aal.luft, r=6378137)
sATM$Bil.luft <- distHaversine(mat, Bil.luft, r=6378137)
sATM$Køb.luft <- distHaversine(mat, Køb.luft, r=6378137)
#Nærmeste lufthavn i km:
sATM <- sATM %>% mutate(min.afstand=round(pmin(sATM$Aal.luft,sATM$Bil.luft,sATM$Køb.luft)/1000,2))
# Distance to turist destinations -----------------------------------------
save(sATM, file="generated_data/fATM.Rdata")
library(geosphere)
library(tidyverse)
sATM <- bATM
# Holidays ----------------------------------------------------------------
# Denmark
# Ferie i Nordjylland (http://skoleferie-dk.dk/skoleferie-nordjylland/)
Jul    <- ifelse(((sATM$month=="December" & 20<=sATM$day) | (sATM$month=="January" & sATM$day<=4)), TRUE,FALSE)
Vinter <- ifelse((sATM$month=="February" & 11<=sATM$day & sATM$day<=26), TRUE,FALSE)
Paaske <- ifelse((sATM$month=="April" & 8 <= sATM$day & sATM$day<=17), TRUE,FALSE)
Sommer <- ifelse(((sATM$month=="June" & 23<=sATM$day) | (sATM$month=="July" & sATM$day>=1)| (sATM$month=="August" & sATM$day<=13)), TRUE,FALSE)
Efter  <- ifelse((sATM$month=="October" & 14<=sATM$day & sATM$day<=22), TRUE,FALSE)
sATM$holliday <- Jul | Vinter | Paaske | Sommer | Efter
# Distance to other ATMs --------------------------------------------------
mat <- as.matrix(data.frame(lon = sATM$atm_lon,
lat = sATM$atm_lat))
Aal.luft <- c(9.842829962 , 57.088999644)
Bil.luft <- c(9.150999396 , 55.73749705)
Køb.luft <- c(12.650462   , 55.620750)
#Afstand er i meter og i luftlinje:
sATM$Aal.luft <- distHaversine(mat, Aal.luft, r=6378137)
sATM$Bil.luft <- distHaversine(mat, Bil.luft, r=6378137)
sATM$Køb.luft <- distHaversine(mat, Køb.luft, r=6378137)
#Nærmeste lufthavn i km:
sATM <- sATM %>% mutate(min.afstand=round(pmin(sATM$Aal.luft,sATM$Bil.luft,sATM$Køb.luft)/1000,2))
# Distance to turist destinations -----------------------------------------
save(sATM, file="generated_data/fATM.Rdata")
library(tidyverse)
library(ggforce)
library(caret)
library(yardstick)
library(knitr)
library(ggthemes)
library(ggridges)
library(kableExtra)
library(VIM)
load(file="generated_data/sATM.Rdata")
set.seed(20092019)
load(file="generated_data/fATM.Rdata")
View(sATM)
fATM
#sATM <- sample_n(data, 10000, replace=F)
#sATM <- data
cv <- trainControl(method = "cv", number = 5)
sATM$euro <- ifelse(sATM$currency == "EUR", TRUE, FALSE)
sATM$euro <- as.factor(sATM$euro)
ml <- sATM %>%
select(euro, month, day, weekday, hour, atm_location, card_type, weather_main, atm_zipcode) %>%
mutate(card_type    = as.factor(card_type),
atm_location = as.factor(atm_location),
weather_main = as.factor(weather_main),
month        = as.factor(month),
weekday      = as.factor(weekday),
day          = as.factor(day),
hour         = as.factor(hour))
index    <- createDataPartition(ml$euro, p = 0.05, list = FALSE)
training <- ml[index,]
test     <- ml[-index,]
ml <- sATM %>%
select(euro, month, day, weekday, hour, atm_location, card_type, weather_main, atm_zipcode, min.afstand, holliday) %>%
mutate(card_type    = as.factor(card_type),
atm_location = as.factor(atm_location),
weather_main = as.factor(weather_main),
month        = as.factor(month),
weekday      = as.factor(weekday),
day          = as.factor(day),
hour         = as.factor(hour))
index    <- createDataPartition(ml$euro, p = 0.05, list = FALSE)
a <- Sys.time()
fit_log <- train(euro ~ .,
data      = training,
trControl = cv,
method    = "glm",
family    = "binomial",
metric    = 'Accuracy')
fit_lok <- train(euro ~ .,
data      = training,
trControl = cv,
tuneGrid  = expand.grid(alpha  = 0.5,
lambda = 0),
method    = "glmnet",
family    = "binomial",
metric    = 'Accuracy')
Sys.time() - a
conf_log <- table(predict(fit_log,  test), test$euro)
conf_log
conf_lok <- table(predict(fit_lok,  test), test$euro)
conf_lok
index    <- createDataPartition(ml$euro, p = 0.25, list = FALSE)
training <- ml[index,]
test     <- ml[-index,]
fit_log <- train(euro ~ .,
data      = training,
trControl = cv,
method    = "glm",
family    = "binomial",
metric    = 'Accuracy')
conf_log <- table(predict(fit_log,  test), test$euro)
conf_log
conf_log <- table(predict(fit_log,  test), test$euro)
conf_log
